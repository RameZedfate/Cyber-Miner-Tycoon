<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>賽博礦工大亨 - Cyber Miner Tycoon</title>
    <!-- 確保 manifest.json 連結正確，使用 cross-origin 屬性 -->
    <link rel="manifest" href="./manifest.json" crossorigin="use-credentials">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'cyborg-blue': '#00F0FF',
                        'cyborg-pink': '#FF00FF',
                        'cyborg-green': '#00FF7F',
                        'dark-bg': '#0f172a',
                    },
                    fontFamily: {
                        mono: ['VT323', 'monospace'],
                    },
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'VT323', monospace;
            background-color: #0f172a;
            color: #00F0FF;
            text-shadow: 0 0 5px #00F0FF;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            max-width: 420px;
            width: 100%;
            padding: 1rem;
            margin: 1rem;
            border: 2px solid #00F0FF;
            box-shadow: 0 0 20px #00F0FF;
            background: rgba(0, 0, 0, 0.7);
        }

        .btn-cyborg {
            background-color: #FF00FF;
            color: #0f172a;
            border: 2px solid #00F0FF;
            box-shadow: 0 0 10px #00F0FF, 0 0 10px #FF00FF inset;
            transition: all 0.1s ease-in-out;
        }

        .btn-cyborg:hover {
            background-color: #00F0FF;
            color: #0f172a;
            box-shadow: 0 0 15px #FF00FF, 0 0 15px #00F0FF inset;
        }
        
        /* 點擊特效 */
        .animate-click {
            animation: pulse-shadow 0.2s ease-out;
        }

        @keyframes pulse-shadow {
            0% { transform: scale(1); box-shadow: 0 0 10px #00F0FF, 0 0 10px #FF00FF inset; }
            50% { transform: scale(0.98); box-shadow: 0 0 20px #FF00FF, 0 0 20px #00F0FF inset; }
            100% { transform: scale(1); box-shadow: 0 0 10px #00F0FF, 0 0 10px #FF00FF inset; }
        }

        .upgrade-card {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #00F0FF80;
            transition: border-color 0.2s;
        }

        .upgrade-card:hover {
            border-color: #FF00FF;
            box-shadow: 0 0 8px #FF00FF80;
        }

        .resource-text {
            color: #00FF7F;
            text-shadow: 0 0 5px #00FF7F;
        }
    </style>
</head>
<body class="select-none">
    <div id="app" class="container rounded-lg">
        <!-- 標題與資源顯示 -->
        <h1 class="text-3xl text-center mb-4 border-b-2 border-cyborg-pink pb-2">CYBER MINER TWA</h1>
        <div class="text-center mb-6">
            <p class="text-lg">資源：<span id="resourceCount" class="resource-text text-4xl">0</span> C-COIN</p>
            <p class="text-sm text-cyborg-green">CPM: <span id="cpm">0.00</span> | CPS: <span id="cps">0</span></p>
        </div>

        <!-- 主要點擊區域 -->
        <div class="flex justify-center mb-6">
            <button id="mineButton" class="btn-cyborg w-3/4 py-4 rounded-full text-2xl" onclick="mine()">
                [:: 挖礦 / HACK ::]
            </button>
        </div>

        <!-- 升級區塊 -->
        <h2 class="text-2xl border-b-2 border-cyborg-blue pb-1 mb-3">升級 / UPGRADES</h2>
        <div id="upgradesContainer" class="space-y-3">
            <!-- 升級卡片將由 JS 生成 -->
        </div>
    </div>

    <script>
        // 全域變數
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        // 初始化遊戲狀態
        let game = {
            resources: 0,
            cpm: 1, // Click Power Multiplier
            cps: 0, // Click Per Second (放置收益)
            upgrades: {
                clickPower: { level: 0, baseCost: 10, costMultiplier: 1.5, baseCpm: 1, type: 'click', name: '駭客工具優化' },
                drone: { level: 0, baseCost: 100, costMultiplier: 1.8, baseCps: 1, type: 'passive', name: '部署礦工無人機' },
                aiFarm: { level: 0, baseCost: 5000, costMultiplier: 2.0, baseCps: 20, type: 'passive', name: 'AI礦場自動化' },
            },
            userId: null,
        };

        // UI 元素
        const resourceCountEl = document.getElementById('resourceCount');
        const cpmEl = document.getElementById('cpm');
        const cpsEl = document.getElementById('cps');
        const mineButton = document.getElementById('mineButton');
        const upgradesContainer = document.getElementById('upgradesContainer');

        // --- Firebase/Firestore 設置與認證 ---
        let db, auth;
        let isAuthReady = false;

        // 引入 Firebase 模組
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 設定 Firebase 登入
        const initFirebase = async () => {
            try {
                // setLogLevel('Debug'); // 開啟除錯日誌
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        game.userId = user.uid;
                        isAuthReady = true;
                        console.log("Firebase Auth Ready. User ID:", game.userId);
                        // 確保在身份驗證完成後立即開始監聽資料
                        loadGameData();
                    } else {
                        // 首次載入或匿名登入
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });

            } catch (error) {
                console.error("Firebase 初始化失敗:", error);
            }
        };

        // 獲取 Firestore 文件參考
        const getGameDocRef = (userId) => {
            // 私人資料路徑: /artifacts/{appId}/users/{userId}/gameData/current
            return doc(db, 'artifacts', appId, 'users', userId, 'gameData', 'current');
        };

        // 從 Firestore 載入資料 (使用 onSnapshot 實時監聽)
        const loadGameData = () => {
            if (!isAuthReady || !game.userId || !db) return;
            
            const docRef = getGameDocRef(game.userId);
            
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const savedData = docSnap.data();
                    console.log("從 Firestore 載入資料:", savedData);
                    // 更新遊戲狀態
                    game.resources = savedData.resources || 0;
                    // 確保升級資料被正確合併，以防新增升級
                    Object.keys(game.upgrades).forEach(key => {
                        if (savedData.upgrades && savedData.upgrades[key]) {
                            game.upgrades[key].level = savedData.upgrades[key].level;
                        }
                    });
                } else {
                    console.log("Firestore 文件不存在，將使用預設值並儲存。");
                    // 文件不存在時，使用預設值並觸發首次儲存
                    saveGameData();
                }
                updateGameStats();
                updateUI();
            }, (error) => {
                console.error("監聽遊戲資料失敗:", error);
            });
        };

        // 儲存遊戲資料到 Firestore
        const saveGameData = async () => {
            if (!isAuthReady || !game.userId || !db) return;

            try {
                const docRef = getGameDocRef(game.userId);
                
                // 僅儲存 level
                const upgradesToSave = {};
                Object.keys(game.upgrades).forEach(key => {
                    upgradesToSave[key] = { level: game.upgrades[key].level };
                });

                await setDoc(docRef, {
                    resources: Math.round(game.resources),
                    upgrades: upgradesToSave,
                    updatedAt: new Date().toISOString()
                });
                // console.log("遊戲資料已儲存。");
            } catch (error) {
                console.error("儲存遊戲資料失敗:", error);
            }
        };

        // --- 遊戲邏輯 ---

        // 更新 CPM 和 CPS
        const updateGameStats = () => {
            game.cpm = 0; // 重置點擊倍率
            game.cps = 0; // 重置放置收益
            
            Object.keys(game.upgrades).forEach(key => {
                const upgrade = game.upgrades[key];
                if (upgrade.type === 'click') {
                    // 點擊升級: 基礎 CPM * (級別 + 1)
                    game.cpm += upgrade.baseCpm * (upgrade.level + 1);
                } else if (upgrade.type === 'passive') {
                    // 放置升級: 基礎 CPS * 級別
                    game.cps += upgrade.baseCps * upgrade.level;
                }
            });

            // 確保 cpm 至少為 1 (基礎點擊)
            if (game.cpm === 0) game.cpm = 1;

            cpmEl.textContent = game.cpm.toFixed(2);
            cpsEl.textContent = game.cps;
        };

        // 點擊挖礦
        function mine() {
            game.resources += game.cpm;
            updateUI();
            
            // 點擊特效
            mineButton.classList.add('animate-click');
            setTimeout(() => {
                mineButton.classList.remove('animate-click');
            }, 200);
            
            // 頻繁點擊時，每隔一段時間儲存一次
            if (Date.now() % 5 === 0) {
                saveGameData();
            }
        }

        // 被動收益
        const passiveIncome = () => {
            if (game.cps > 0) {
                // 由於計時器是每秒一次，直接加上 CPS 即可
                game.resources += game.cps;
                updateUI();
                saveGameData(); // 每次被動收益都儲存
            }
        };

        // 升級邏輯
        function buyUpgrade(key) {
            const upgrade = game.upgrades[key];
            const cost = calculateCost(upgrade);

            if (game.resources >= cost) {
                game.resources -= cost;
                upgrade.level += 1;
                updateGameStats();
                updateUI();
                saveGameData(); // 升級後儲存
            } else {
                showTemporaryMessage('資源不足！');
            }
        }

        // 計算升級成本
        const calculateCost = (upgrade) => {
            return Math.round(upgrade.baseCost * Math.pow(upgrade.costMultiplier, upgrade.level));
        };

        // --- UI 渲染與更新 ---

        // 渲染單個升級卡片
        const renderUpgradeCard = (key) => {
            const upgrade = game.upgrades[key];
            const cost = calculateCost(upgrade);
            const nextBonus = upgrade.type === 'click' 
                ? `下次 +${(upgrade.baseCpm * upgrade.costMultiplier).toFixed(2)} CPM` 
                : `下次 +${upgrade.baseCps} CPS`;
            
            const cardEl = document.createElement('div');
            cardEl.className = `upgrade-card p-3 rounded-md flex justify-between items-center ${game.resources >= cost ? 'cursor-pointer' : 'opacity-50 cursor-not-allowed'}`;
            cardEl.onclick = () => buyUpgrade(key);
            
            cardEl.innerHTML = `
                <div>
                    <p class="text-xl text-cyborg-pink">${upgrade.name} [Lvl ${upgrade.level}]</p>
                    <p class="text-xs text-cyborg-green">${nextBonus}</p>
                </div>
                <div class="text-right">
                    <p class="text-lg resource-text">${cost} C-COIN</p>
                    <button class="px-2 py-1 bg-cyborg-blue text-dark-bg text-sm rounded-md mt-1 font-mono hover:bg-cyborg-pink">購買</button>
                </div>
            `;
            
            return cardEl;
        };

        // 更新所有 UI 
        const updateUI = () => {
            resourceCountEl.textContent = Math.round(game.resources).toLocaleString();
            upgradesContainer.innerHTML = ''; // 清空舊的
            
            Object.keys(game.upgrades).forEach(key => {
                const card = renderUpgradeCard(key);
                upgradesContainer.appendChild(card);
            });
        };

        // 顯示暫時訊息（取代 alert）
        function showTemporaryMessage(message) {
            const messageEl = document.createElement('div');
            messageEl.textContent = message;
            messageEl.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #FF00FF; color: #0f172a; padding: 15px 30px;
                border: 2px solid #00F0FF; border-radius: 8px; z-index: 1000;
                box-shadow: 0 0 20px #FF00FF; font-size: 1.5rem;
                animation: fadeout 3s forwards;
            `;
            document.body.appendChild(messageEl);

            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeout {
                    0% { opacity: 1; }
                    80% { opacity: 1; }
                    100% { opacity: 0; display: none; }
                }
            `;
            document.head.appendChild(style);

            setTimeout(() => {
                document.body.removeChild(messageEl);
                document.head.removeChild(style);
            }, 3000);
        }

        // --- 啟動遊戲 ---

        // 遊戲初始化
        initFirebase();

        // 被動收益計時器 (每秒一次)
        setInterval(passiveIncome, 1000); 

    </script>
</body>
</html>
